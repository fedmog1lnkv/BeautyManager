<script setup lang="ts">
import { computed, ref } from 'vue';
import InputMask from 'primevue/inputmask';
import AuthRepository from '@/data/repositories/AuthRepository';
import StaffRole from '@/data/models/StaffRole';
import StaffProfile from '@/data/models/StaffProfile';
import router from '@/router/index';

const phoneNumber = ref('');
const code = ref('');
const showCodeInput = ref(false);
const isLoading = ref(false);

const isPhoneComplete = computed(() => phoneNumber.value.length === 18);

const submitPhoneNumber = async () => {
    if (!isPhoneComplete.value) return;

    isLoading.value = true;
    try {
        await AuthRepository.sendPhone(phoneNumber.value);
        showCodeInput.value = true;
    } catch (error) {
        showCodeInput.value = false;
        alert(error);
    } finally {
        isLoading.value = false;
    }
};

const submitCode = async () => {
    try {
        let profile: StaffProfile = await AuthRepository.sendCode(phoneNumber.value, code.value);
        switch (profile.role) {
            case StaffRole.Manager:
                await router.push({ name: 'dashboard' });
                break;
            default:
                await router.push({ name: 'accessDenied' });
                break;
        }
    } catch (e) {
        showCodeInput.value = false;
        alert(e);
    }
};
</script>

<template>
    <div class="bg-surface-50 dark:bg-surface-950 flex items-center justify-center min-h-screen min-w-[100vw] overflow-hidden">
        <div class="flex flex-col items-center justify-center">
            <div style="border-radius: 56px; padding: 0.3rem; background: linear-gradient(180deg, var(--primary-color) 10%, rgba(33, 150, 243, 0) 30%)">
                <div class="w-full bg-surface-0 dark:bg-surface-900 py-20 px-8 sm:px-20" style="border-radius: 53px">
                    <div class="text-center mb-8">
                        <div class="text-surface-900 dark:text-surface-0 text-3xl font-medium mb-4">Добро пожаловать!</div>
                    </div>

                    <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g id="Group 1">
                            <path id="Vector" d="M110 338.687V58.9604H165.546C194.318 58.9604 216.696 64.9546 232.68 76.9429C248.665 88.9312 256.657 105.581 256.657 126.894C256.657 142.612 251.995 156.066 242.67 167.255C233.346 178.177 220.292 185.637 203.509 189.633V192.031C226.42 194.961 244.269 202.953 257.056 216.007C270.11 228.795 276.637 245.045 276.637 264.759C276.637 287.937 267.713 306.054 249.863 319.106C232.014 332.159 206.972 338.687 174.737 338.687H110ZM165.945 68.5511H137.173V188.434H165.546C207.638 188.434 228.684 168.454 228.684 128.493C228.684 88.5316 207.771 68.5511 165.945 68.5511ZM174.737 198.025H137.173V329.097H174.737C223.489 329.097 247.865 307.252 247.865 263.561C247.865 219.87 223.489 198.025 174.737 198.025Z" fill="var(--primary-color)"/>
                            <path id="Vector_2" d="M239.38 320.53L241.778 296.553H244.175C254.565 305.61 266.287 312.672 279.341 317.733C292.395 322.793 305.315 325.325 318.103 325.325C336.22 325.325 350.871 320.396 362.06 310.54C373.249 300.415 378.844 286.963 378.844 270.179C378.844 260.854 376.711 252.197 372.45 244.204C368.454 236.212 361.66 228.087 352.07 219.828C342.745 211.57 329.826 202.645 313.308 193.054C301.853 186.394 290.93 179.468 280.54 172.275C270.15 164.815 261.625 156.29 254.965 146.7C248.305 136.843 244.974 125.121 244.974 111.534C244.974 91.2873 252.301 75.0362 266.953 62.7817C281.605 50.2604 300.92 44 324.896 44C335.552 44 347.009 45.1988 359.263 47.5965C371.516 49.7278 380.976 52.5251 387.635 55.9883L385.637 78.3664H383.239C368.054 61.8491 348.608 53.5906 324.896 53.5906C307.847 53.5906 294.126 57.9863 283.737 66.7777C273.347 75.3029 268.152 86.8915 268.152 101.544C268.152 112.467 270.949 121.924 276.544 129.916C282.404 137.642 289.864 144.702 298.922 151.095C307.979 157.223 317.703 163.217 328.093 169.078C340.082 176.005 351.67 183.33 362.859 191.056C374.314 198.782 383.639 208.106 390.832 219.029C398.29 229.685 402.021 243.139 402.021 259.39C402.021 274.309 398.559 287.497 391.631 298.951C384.704 310.14 374.848 318.932 362.06 325.325C349.538 331.719 334.887 334.916 318.103 334.916C307.448 334.916 294.926 333.583 280.54 330.92C266.154 328.257 252.434 324.791 239.38 320.53Z" fill="var(--primary-color)"/>
                        </g>
                        <path id="MANAGER" d="M78.7342 443V440.376H79.4382C80.4196 440.376 81.2942 440.291 82.0622 440.12C82.8302 439.949 83.4489 439.651 83.9182 439.224C84.3876 438.755 84.6222 438.157 84.6222 437.432V402.488C84.6222 401.848 84.3876 401.379 83.9182 401.08C83.4489 400.739 82.8302 400.504 82.0622 400.376C81.2942 400.248 80.4196 400.184 79.4382 400.184H78.7342V397.56H93.3903L106.382 438.008L105.23 437.88L118.734 397.56H133.134V400.184H132.558C131.065 400.184 129.806 400.333 128.782 400.632C127.758 400.931 127.246 401.549 127.246 402.488V438.072C127.246 439.011 127.758 439.629 128.782 439.928C129.806 440.227 131.065 440.376 132.558 440.376H133.134V443H115.79V440.376H116.366C117.134 440.376 117.881 440.355 118.606 440.312C119.374 440.269 120.014 440.205 120.526 440.12C121.038 439.992 121.294 439.864 121.294 439.736V398.52L121.934 398.648L106.702 443.128H102.798L87.5662 398.648L88.2703 398.712V439.224C88.2703 439.48 88.5263 439.715 89.0382 439.928C89.5502 440.099 90.1902 440.227 90.9583 440.312C91.7689 440.355 92.5582 440.376 93.3263 440.376H93.9023V443H78.7342ZM152.628 424.12H171.636L171.7 427.192H152.052L152.628 424.12ZM161.076 400.184L162.292 401.528L149.3 439.096C149.3 439.352 149.514 439.587 149.94 439.8C150.41 439.971 151.007 440.12 151.732 440.248C152.5 440.333 153.332 440.376 154.228 440.376H155.508V443H141.364V440.376H141.748C142.858 440.376 143.775 440.163 144.5 439.736C145.268 439.309 145.866 438.477 146.292 437.24L160.116 397.56H165.94L180.34 438.456C180.639 439.309 181.13 439.843 181.812 440.056C182.538 440.269 183.412 440.376 184.436 440.376H184.756V443H168.5V440.376H169.524C170.335 440.376 171.146 440.355 171.956 440.312C172.767 440.269 173.428 440.205 173.94 440.12C174.495 439.992 174.772 439.864 174.772 439.736L161.076 400.184ZM193.037 443V440.376H193.741C194.722 440.376 195.597 440.269 196.365 440.056C197.133 439.843 197.751 439.501 198.221 439.032C198.69 438.563 198.925 437.965 198.925 437.24V402.488C198.925 401.848 198.69 401.379 198.221 401.08C197.751 400.739 197.111 400.504 196.301 400.376C195.533 400.248 194.679 400.184 193.741 400.184H193.037V397.56H206.797L229.453 437.112L228.621 437.304V401.592C228.621 401.251 228.343 400.995 227.789 400.824C227.277 400.611 226.594 400.461 225.741 400.376C224.93 400.248 224.055 400.184 223.117 400.184H221.965V397.56H238.157V400.184H237.453C236.514 400.184 235.639 400.291 234.829 400.504C234.018 400.717 233.378 401.059 232.909 401.528C232.439 401.955 232.205 402.552 232.205 403.32V443H226.573L201.677 399.608L202.573 399.352V438.968C202.573 439.267 202.829 439.523 203.341 439.736C203.895 439.949 204.599 440.12 205.453 440.248C206.306 440.333 207.181 440.376 208.077 440.376H209.229V443H193.037ZM256.243 424.12H275.251L275.315 427.192H255.667L256.243 424.12ZM264.691 400.184L265.907 401.528L252.915 439.096C252.915 439.352 253.129 439.587 253.555 439.8C254.025 439.971 254.622 440.12 255.347 440.248C256.115 440.333 256.947 440.376 257.843 440.376H259.123V443H244.979V440.376H245.363C246.473 440.376 247.39 440.163 248.115 439.736C248.883 439.309 249.481 438.477 249.907 437.24L263.731 397.56H269.555L283.955 438.456C284.254 439.309 284.745 439.843 285.427 440.056C286.153 440.269 287.027 440.376 288.051 440.376H288.371V443H272.115V440.376H273.139C273.95 440.376 274.761 440.355 275.571 440.312C276.382 440.269 277.043 440.205 277.555 440.12C278.11 439.992 278.387 439.864 278.387 439.736L264.691 400.184ZM336.106 425.336V436.28C335.466 437.048 334.57 437.859 333.418 438.712C332.308 439.565 330.964 440.376 329.386 441.144C327.85 441.869 326.164 442.467 324.33 442.936C322.538 443.405 320.639 443.64 318.634 443.64C315.178 443.64 312.042 443.085 309.226 441.976C306.41 440.867 303.978 439.288 301.93 437.24C299.882 435.149 298.303 432.675 297.194 429.816C296.127 426.957 295.594 423.779 295.594 420.28C295.594 416.867 296.17 413.731 297.322 410.872C298.474 408.013 300.074 405.539 302.122 403.448C304.17 401.357 306.538 399.757 309.226 398.648C311.956 397.496 314.858 396.92 317.93 396.92C320.66 396.92 323.071 397.347 325.162 398.2C327.295 399.053 329.066 400.248 330.474 401.784C331.924 403.32 333.012 405.155 333.738 407.288L331.498 406.648L332.522 397.56H335.85V411H332.266C331.583 408.867 330.602 407.011 329.322 405.432C328.084 403.853 326.527 402.616 324.65 401.72C322.772 400.781 320.532 400.312 317.93 400.312C315.668 400.312 313.556 400.781 311.594 401.72C309.674 402.659 307.988 404.003 306.538 405.752C305.13 407.501 304.02 409.613 303.21 412.088C302.399 414.52 301.994 417.251 301.994 420.28C301.994 423.352 302.378 426.125 303.146 428.6C303.914 431.075 305.002 433.187 306.41 434.936C307.86 436.643 309.61 437.965 311.658 438.904C313.748 439.8 316.095 440.248 318.698 440.248C320.874 440.248 322.73 439.992 324.266 439.48C325.844 438.968 327.124 438.392 328.106 437.752C329.13 437.069 329.876 436.515 330.346 436.088V425.336C330.346 424.397 329.812 423.779 328.746 423.48C327.722 423.181 326.399 423.032 324.778 423.032H324.202V420.536H340.842V423.032H340.586C339.391 423.032 338.346 423.181 337.45 423.48C336.554 423.779 336.106 424.397 336.106 425.336ZM384.382 429.368V443H350.334V440.376H350.91C352.404 440.376 353.662 440.227 354.686 439.928C355.71 439.629 356.222 439.011 356.222 438.072V402.488C356.222 401.549 355.71 400.931 354.686 400.632C353.662 400.333 352.404 400.184 350.91 400.184H350.334V397.56H382.654V409.592H379.646L378.814 403.832C378.729 403.021 378.388 402.403 377.79 401.976C377.236 401.507 376.382 401.187 375.23 401.016C374.121 400.845 372.649 400.76 370.814 400.76H362.174V439.8H372.414C373.78 439.8 374.953 439.757 375.934 439.672C376.958 439.544 377.79 439.373 378.43 439.16C379.07 438.904 379.54 438.584 379.838 438.2C380.18 437.773 380.393 437.261 380.478 436.664L381.246 429.368H384.382ZM360.702 418.296C362.708 418.253 364.606 418.211 366.398 418.168C368.19 418.083 369.918 417.997 371.582 417.912C373.289 417.784 374.974 417.656 376.638 417.528V422.072C374.974 421.859 373.289 421.709 371.582 421.624C369.918 421.496 368.19 421.411 366.398 421.368C364.606 421.283 362.708 421.219 360.702 421.176V418.296ZM415.668 422.264L421.364 421.304L430.836 438.52C431.134 439.075 431.476 439.48 431.86 439.736C432.286 439.992 432.798 440.163 433.396 440.248C433.993 440.333 434.654 440.376 435.38 440.376H435.828V443H426.356L415.668 422.264ZM407.732 439.736C407.732 439.864 407.881 439.971 408.18 440.056C408.478 440.099 408.862 440.163 409.332 440.248C409.844 440.291 410.398 440.333 410.996 440.376C411.593 440.376 412.169 440.376 412.724 440.376H413.556V443H395.892V440.376H396.468C397.961 440.376 399.22 440.227 400.244 439.928C401.268 439.629 401.78 439.011 401.78 438.072V402.488C401.78 401.549 401.268 400.931 400.244 400.632C399.22 400.333 397.961 400.184 396.468 400.184H395.892V397.56H414.196C417.652 397.56 420.596 398.115 423.028 399.224C425.502 400.291 427.401 401.784 428.724 403.704C430.046 405.624 430.708 407.864 430.708 410.424C430.708 412.6 430.217 414.541 429.236 416.248C428.297 417.912 426.932 419.32 425.14 420.472C423.348 421.581 421.193 422.371 418.676 422.84C418.206 422.925 417.694 423.011 417.14 423.096C416.628 423.139 416.073 423.181 415.476 423.224C414.921 423.267 414.366 423.288 413.812 423.288H406.452V420.216H413.812C416.286 420.216 418.292 419.832 419.828 419.064C421.364 418.296 422.494 417.187 423.22 415.736C423.988 414.243 424.372 412.472 424.372 410.424C424.372 408.461 423.988 406.755 423.22 405.304C422.452 403.853 421.3 402.744 419.764 401.976C418.27 401.165 416.372 400.76 414.068 400.76H407.732V439.736Z" fill="var(--primary-color)"/>
                    </svg>

                    <!-- ОБЛАСТЬ С ФИКСИРОВАННОЙ ВЫСОТОЙ -->
                    <div class="relative w-full h-[150px] flex items-center justify-center">
                        <!-- Ввод номера -->
                        <div v-show="!showCodeInput" class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center transition-opacity duration-300">
                            <label for="phone" class="block text-surface-900 dark:text-surface-0 text-xl font-medium mb-2">Номер телефона</label>
                            <InputMask v-model="phoneNumber" mask="+7 (999) 999-99-99" placeholder="+7 (999) 999-99-99" class="w-full md:w-[30rem] mb-8 p-3 border border-gray-300 rounded" required fluid />
                            <button class="w-full text-white py-3 rounded" :class="isPhoneComplete && !isLoading ? 'bg-blue-500' : 'bg-gray-400 cursor-not-allowed'" :disabled="!isPhoneComplete || isLoading" @click="submitPhoneNumber">
                                <span v-if="isLoading">Загрузка...</span>
                                <span v-else>Отправить код</span>
                            </button>
                        </div>

                        <!-- Ввод кода -->
                        <div v-show="showCodeInput" class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center transition-opacity duration-300">
                            <label for="code" class="block text-surface-900 dark:text-surface-0 text-xl font-medium mb-2">Введите код</label>
                            <InputMask id="code" type="text" v-model="code" mask="999-999" placeholder="999-999" class="w-full md:w-[30rem] mb-8 p-3 border border-gray-300 rounded" pattern="^[0-9]{6}$" required fluid />
                            <button class="w-full bg-blue-500 text-white py-3 rounded" @click="submitCode">Далее</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<style scoped>
/* Стили для кнопок и ввода */
button {
    cursor: pointer;
}
</style>
